* 美信开发板Firmware固件代码学习研究** 美信Firmware层次结构   美信开发板Firmware采用的是Threadx实时操作系统，使用U-boot引导程序模式进行系统引导启动，同时配置相关硬件驱动信息。在操作系统之上，Firmware结构是由四部分组成，分别是： System Services Module,  Transport Module,  Diagnostic Interface Module, 和 Personality Module。其组成结构图如下：[[file:固件结构图.jpg]]下面针对每一部分做简单的介绍：1. VOS (Maxim Operating System)     美信操作系统层：美信开发板运行的操作系统是Threadx实时操作系统，在这一层里包括底层kernel和管理开发板硬件的驱动。实现了实时操作服务，中断处理服务，和运行优先级管理等多种底层基础服务。2. System Services module      System Services module 是用户与底层硬件交互的中间层，在这一层里，在底层驱动代码基础上，针对串口，网口，CPU，美信EXpend芯片等主要硬件提供大量操作的API函数。上层用户可以直接调用这些API函数与底层硬件进行交互操作。3. Transport module    Transport module 是各种协议数据传输的代码实现层。在这一层里，对需要传输的数据进行各种协议的数据封装，同时调用Syetem层的API函数，实现数据向底层物理硬件层进行传输。在这一层里，针对SAS协议，串口协议，TCp网络协议等与外界交互的协议，都有对应的代码实现。这只一层里也提供了大量的API函数，供上层用户层进行调用使用。 4. Diagnostic Interface module   Diagnostic Interface module 是诊断测试层，在这一层里，根据Transport层提供的函数，针对网络接口和SAS端口，编写了测试程序，用户可以运行这些测试函数，对对应的端口进行测试，实现各个端口端口的功能，性能诊断。用户还可以根据需要在此层编写自己的测试函数。5. Personality Module      Personality Module 在这一层提供了大量的数据结构和缺省配置参数，实现硬件的参数配置，以便系统正常运行工作，同时在这一层提供大量中断运行处理服务程序，是对各种中断的及时处理，和反馈处理结果。   美信开发板Firmware固件在操作系统上的四层之间联系非常紧密，没有绝对的上下层关系，他们之间都是互相调用的，以实现实时操作服务，快速处理各种中断响应。   以上只是大体上对代码结构进行了分析，可能会出现错误，请大家指正，针对每一部分还需要仔细阅读学习。** 美信开发板系统运行流程   下面是美信开发板正常启动运行的流程图：   [[file:工作流程图.jpg]]     针对上面的流程图的每一部分，做具体的详细的介绍：1. Initialization State    当主板开始上电或者复位按钮被按下时，cpu跳到0XBFC00000地址位置，U-boot从此装入引导firmware开始运行，系统开始检测CPU，内存，EPC，美信expender芯片等硬件设备的Register状态，检测成功后，开始构建C运行环境，运行Threadx操作系统，系统启动成功，进入系统自检状态。2. Self-Test State   在系统自检状态中，系统进入ROM monitor模式，串口会显示启动信息，同时系统会运行自检BIST程序或者其他检测程序，对SAS端口，UART0，网口等端口硬件和端口连接设硬件设备进行检测。如果检测通过，系统就进入参数配置状态。如果检测失败，就进入检测失败状态。3. Configuration State   参数配置状态：系统在此状态，根据EEprom中配置参数值，配置系统和硬件对应的参数，同时为系统的正常运行提供中断服务配置。系统配置成功，就进入正常等待工作模式，如果配置过程中出现问题，系统还会计入检测失败状态。4. Idle State    Idle State ：是系统启动成功后的正常工作状态。系统在Idle State 状态中，等待中断，如果中断发生，系统自动将中断加入中断优先级执行表中，系统根据中断的优先级别启动线程运行对应的中断服务程序。如果多个中断服务线程再运行，系统会在1/50秒的时间切换工作线程，从而保证系统正常运行。5. Self-Test Failure State    Self-Test Failure State ：系统在自检失败或配置失败后都会进入此状态，在此状态下，系统串口可以打印错误日志信息，进行错误诊断，同时接受串口的固件升级操作。可以更新升级固件，重启系统，在此进行初始化。** 美信开发板Firmware固件源代码目录树介绍：   固件源代码的目录树显示如下：├─app│  └─sas│      ├─inc│      └─src├─boot│  ├─build│  ├─inc│  ├─misc│  └─src├─dev│  ├─build│  ├─inc│  └─src├─diag│  ├─common│  │  └─inc│  ├─ses│  │  └─inc│  ├─sspSes│  │  ├─build│  │  └─src│  └─tcp│      ├─build│      ├─inc│      ├─misc│      └─src├─docs│  └─pdf├─m5├─pm│  └─max720xx│      ├─build│      │  └─720xx01│      │      ├─exe│      │      └─obj│      ├─misc│      └─src├─sys│  ├─build│  ├─inc│  └─src├─threadx│  ├─build│  ├─inc│  │  └─tx│  └─src├─tools│  └─inbandfw│      ├─common│      ├─scansas│      ├─sesburn│      ├─spcburn│      ├─tcp│      └─writebuffer└─transpt    ├─common    │  └─inc    ├─i2c    │  ├─build    │  ├─inc    │  └─src    ├─sasGui    │  ├─build    │  ├─inc    │  └─src    ├─sasPhy    │  ├─build    │  ├─inc    │  └─src    ├─selfCfg    │  ├─build    │  ├─inc    │  └─src    ├─smp    │  ├─build    │  ├─inc    │  └─src    ├─ssp    │  ├─build    │  ├─inc    │  └─src    └─tcp        ├─build        ├─inc        ├─lwip        │  └─src        │      ├─api        │      ├─contrib        │      │  └─netbios        │      ├─core        │      │  ├─ipv4        │      │  ├─ipv6        │      │  └─snmp        │      ├─include        │      │  ├─arch        │      │  ├─contrib        │      │  ├─ipv4        │      │  │  └─lwip        │      │  ├─ipv6        │      │  │  └─lwip        │      │  ├─lwip        │      │  └─netif        │      └─netif        │          └─ppp        └─src   针对目录树做简单的说明：1. app 目录 包含美信expender多个PM版本的共同代码部分。因为美信的开发板有多个版本，所以美信把代码的共同部分放到此目录里。2. boot 目录 U-boot引导程序的源代码。3. dev  目录 硬件设备驱动源代码。4. diag 目录 诊断测试源代码。5. docs 目录 与固件开发的相关PDF文档。6. pm   目录 包含开发编译的配置信息，Makefile文件，已经每个开发版本的特有版本配置信息。7. sys  目录 系统硬件操作的API函数源代码。8. threadx 目录 操作系统源代码9. tools目录 实现固件升级和开发板搜索的程序源代码。10.transport 目录 数据传输协议实现的源代码。11.每个目录都基本包含build inc 和src 三个目录，每个目录内容如下：build 编译文件makefile；inc .h头文件；src  .c 源代码文件。   以上只是对代码结构树的大体分析，可能会出现错误，请大家指正，针对每一部分还需要仔细阅读学习。* 美信开发板固件（Firmware）开发环境设置、编译和升级流程** 美信开发工具Maxim Gnu Toolchain Windows环境下安装流程1. 解压MGT200.zip文件到一个磁盘的根目录下，注意一定是根目录，否则安装会失败，我们示例解压到F盘。2. 进入F盘，运行setup.exe文件出现安装界面，按照需求选择安装。3. 在CD/Network Drive Letter 选择安装文件所在的盘符，即是F盘。4. 在Destination Drive Letter 选择运行环境需要安装到的磁盘，即是D盘。5. 在Destination Directory 输入安装的路径。6. 点击运行Install MGT Now 按钮进行安装，安装成功后，在DOS窗口会有安装成功的提示。7. 安装成功后，可以到安装目录下，运行Maxim GNU Tool快捷键进入DOS窗口，编译开发环境就可以正常运行了。8. 注意在运行开发环境时，必须关掉360安全卫士，否则会提示，运行环境的某些命令是木马，无法正常运行。9. 安装详细流程可以参考文档:[[file:html/美信开发环境安装流程.html]]。** Firmware开发编译流程1. 在MGT编译工具的安装目录下新建一个文件夹。2. 将解压后的Firmware固件源代码复制到此目录下。3. 进入安装目录，运行mgtShellStar.bat软件进入命令行窗口。4. 利用linux命令进入下面目录 /max720xx_05.01_Thx_full/pm/max720xx/build。5. 运行damke -f 720XX01.mk 命令进行编译。6. 注意，必须首先设置sdk路径，否则运行上述命令会提示错误，无法编译，   设置方法如下：export SDKROOT=/max720xx_05.01_Thx_full/ （pm 所在的路径）。7. 编译成功后，在~/build/720xx1/exe目录下生成需要的固件Firmware软件，可以通过GUI界面的com口和网口进行升级。** Firmware升级版本流程1. 在windows客户端安装GUI软件SAS ProductS Manage 5.03.03版本。2. 运行GUI管理软件，通过串口，或者网口连接，GUI软件的网络端口具有自动搜索局域网中存在开发板的功能。3. 通过串口，可以直接连接到开发板上，通过网口可以登录到局域网中所有的开发板。如果网络连接成功会在现在网络下拉菜单里出现所有连接成功开发板名称和IP地址。4. 与开发板连接成功后，通过Tools菜单中的Update Expender Firmware按钮升级开发板固件。5. 点击后出现对话框，可以选择需要升级的文件后缀是.fuf 通过Firmware固件编译成功后会生成*.fuf文件，选中此文件就可以升级。6. 选中后点击Update按钮，系统会自动将最新的固件升级到开发板上。* 美信开发板参数配置详解** 开发板参数配置存储说明   美信开发板将参数是存储在EEPROM区域内，断电不会丢失，系统启动成功后，首先从EEPROM区域内读取配置参数的值，如果没有存储此参数的，系统会选择在Firmware软件中缺省的值，作为参数值。所以，更改Firmware软件中的缺省参数值，开发板显示参数是没有意义，除非在开发板上EEPROM没有存储参数的值。这样设计也可以，升级或者更换Firmware固件，对系统的正常运行没有影响，因为参数没有改变。** 参数设置方法   美信开发板的配置参数可以通过连接到开发板后，在串口的命令窗口里，利用命令进行修改。主要命令修改参数如下：1.开发板SAS Address 每一款开发板都有一个全球唯一的SAS地址通过配置此参数设置开发板的SAS地址  命令是： cfgsasaddr   使用说明：     cfgsasaddr <set/clr/get> [MSDWORD] [LSDWORD] -     sets/clears/gets the SAS Address (2 DWORDs) in NVRAM     Example Usage:     cfgsasaddr clr: clears SAS Address in NVRAM     cfgsasaddr set 50001c10 7160B000: sets the SAS Address in NVRAM     cfgsasaddr get:  displays the SAS Address of Expander 2. 配置开发板的ID号，这个ID号的范围是0~255 一个字节的长度，主要是为了在局域网内设置唯一的名称。   命令是：cfgboardid    使用说明：     cfgboardid <set/clr/get> [id (decimal)] -     sets/clears/gets the board ID     Example Usage:     cfgboardid clr: reinit board ID to default     cfgboardid set 10: set the board ID to 10 (0xA)     boardid get: displays the current boardID3. 配置美信主板的类型，主要是包括开发板和生产板两种类型。   命令是： cfgboardtype    使用说明：cfgboardtype <set/clr/get> [identifier 0 or 1] -     sets/clears/gets the board Type where:       0 - standard Maxim 720xx product board       1 - small Maxim 72018 EvKit     Example Usage:     cfgboardtype clr: reinit board type to default - defined in pm.h     cfgboardtype set 1: set the board type to small 72018 EvKit     cfgboardtype get: displays the current boardtype4. 配置是否动态分配IP地址，即是否动态DHCP   命令是：cfgdhcp    使用说明：cfgdhcp [on/off] [timeout(secs)]     Enable/Disable DHCP and specify timeout where unspecified or 0 (zero) means no timeout5. 配置美信主板的IP地址。静态设置IP地址。   命令是：cfgip    使用说明：cfgip [<IP address> <subnet mask> <gateway>]     Set IP configuration.     Example Usage:          cfgip 192.168.100.214 255.255.255.0 192.168.100.16. 配置美信主板的网口的MAC地址。可以改变主板网口的MAC地址。   命令是：cfgmacaddr    使用说明：cfgmacaddr [xx:xx:xx:xx:xx:xx]     Get/set local MAC address.** 主板的参数变量类型   EEPROM中存储参数变量有两种类型，一种是系统配置需要的参数，另一种是用户根据需要自己设置参数名称和参数值，以方便实现某些用户需求工作。   系统配置参数可以通过上述参数设置的方法，进行设置。而用户自己定义的参数值命令的方式进行设置。主要命令如下：1. 删除用户增加的参数名称。   命令是： nvsdel     使用说明：nvsdel <paramName str>      Delete parameter of specified name from nvstore.2. 增加用户参数名称。   命令是：nvsexec    使用说明：nvsexec <paramName str> 3. 读取设置的用户参数值，只能读取用户自己设置的参数值，系统的配置参数值需要分别通过对应的命令读取。   命令是： nvsread    使用说明：nvsread <paramName str (opt)>    Try to read a param from nvstore. Search for first match of specifiedstring.     If no string is specified dump all named params.4. 读取EEPROM空间中存储的所有参数值。   命令是: nvstoreread    使用说明;nvstoreread  - Read current data in NV Store5. 将用户增加一个参数，设置为字节型，同时赋值。   命令是：nvswbyte    使用说明：nvswbyte <paramName str> <value>     Create or replace a variable with paramName name. Value is decimal by      or hex if prefixed by 0x6. 将用户增加的一个参数，设置为int类型，同时赋值。   命令是： nvswint    使用说明：nvswbyte <paramName str> <value>     Create or replace a variable with paramName name. Value is decimal by      or hex if prefixed by 0x. Only unsigned values accepted.7. 将用户增加的一个参数，设置为string类型，同时赋值。   命令是： nvswstr    使用说明：nvswstr <paramName str> <str0> <str1> <strn>    Create or replace a variable with paramName name. Value is specified in     ASCII. Spaces will be kept.        用户使用上述命令的流程，首先使用2 增加一个参数名称，使用5或6或7 给此参数赋值，如果觉得不需要了或者出现错误了，可以通过1 删除此参数。**  EEPROM编程存储参数    在美信提供的一份说明书里，提及可以通过API函数设置存储EEPROM区域内的参数值，具体见：[[file:pdf/NVStorageUG.pdf]].在文档里，美信提供了大量有关主板配置参数的设计，同时提供API函数，可以实现对EEPROM区域内的参数值，进行操作，具体操作流程，还需要进一步熟悉文档，测试工作流程，优化参数配置流程，提高工作效率。   